name: ðŸš€ Auto Update File List

on:
  push:
    paths:
      - 'files/**'
  workflow_dispatch:

jobs:
  update-file-list:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ Setup jq
      run: sudo apt-get install -y jq bc
      
    - name: ðŸ”„ Generate file list
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼
        TEMP_FILE=$(mktemp)
        echo "[" > "$TEMP_FILE"
        
        FIRST=true
        for file in files/*.pdf; do
          if [ -f "$file" ]; then
            if [ "$FIRST" = false ]; then
              echo "," >> "$TEMP_FILE"
            fi
            
            filename=$(basename "$file")
            size=$(stat -c%s "$file")
            modified=$(date -r "$file" +"%d.%m.%Y %H:%M")
            
            # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€
            if [ $size -gt 1048576 ]; then
              size_display=$(echo "scale=1; $size/1048576" | bc)" MB"
            elif [ $size -gt 1024 ]; then
              size_display=$(echo "scale=1; $size/1024" | bc)" KB"
            else
              size_display="$size B"
            fi
            
            # ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸Ð· Ð¸Ð¼ÐµÐ½Ð¸ Ñ„Ð°Ð¹Ð»Ð°
            description="Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚"
            [[ $filename == *"Ð¾Ñ‚Ñ‡ÐµÑ‚"* ]] && description="Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚"
            [[ $filename == *"Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†"* ]] && description="Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ"
            [[ $filename == *"Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†"* ]] && description="ÐŸÑ€ÐµÐ·ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ"
            
            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² JSON
            jq -n \
              --arg name "$filename" \
              --arg url "files/$filename" \
              --arg size "$size_display" \
              --arg modified "$modified" \
              --arg desc "$description" \
              '{
                name: $name,
                url: $url,
                size: $size,
                modified: $modified,
                description: $desc
              }' >> "$TEMP_FILE"
            
            FIRST=false
          fi
        done
        
        echo "]" >> "$TEMP_FILE"
        
        # Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼
        jq '.' "$TEMP_FILE" > file-list.json
        rm "$TEMP_FILE"
        
    - name: ðŸ’¾ Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add file-list.json
        git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update file list"
        git push
