name: Update File List

on:
  push:
    paths:
      - 'files/**'
    branches: [ main ]
  workflow_dispatch: # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  update-file-list:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update file list
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ file-list.json
        node -e "
        const fs = require('fs');
        const path = require('path');
        const filesDir = './files';
        
        const files = fs.readdirSync(filesDir).filter(f => f !== '.gitkeep');
        const fileList = files.map(filename => {
          const filePath = path.join(filesDir, filename);
          const stats = fs.statSync(filePath);
          
          const formatSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
          };
          
          const formatDate = (date) => {
            return date.toLocaleDateString('ru-RU', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            });
          };
          
          return {
            name: filename,
            url: 'https://raw.githubusercontent.com/${{ github.repository }}/main/files/' + encodeURIComponent(filename),
            size: formatSize(stats.size),
            modified: formatDate(stats.mtime),
            description: filename.replace(/\\.[^/.]+$/, '')
          };
        });
        
        fs.writeFileSync('./file-list.json', JSON.stringify(fileList, null, 2));
        console.log('Updated file-list.json with ' + fileList.length + ' files');
        "
    
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add file-list.json
        git diff --staged --quiet || git commit -m "ðŸ¤– Auto-update file list"
        git push
